"""
Celery åº”ç”¨é…ç½®æ¨¡å—

è¿™ä¸ªæ¨¡å—å±•ç¤ºäº†å¦‚ä½•é…ç½® Celery åº”ç”¨ï¼ŒåŒ…æ‹¬ï¼š
1. æ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰- Redis
2. ç»“æœåç«¯ï¼ˆResult Backendï¼‰- Redis
3. ä»»åŠ¡è·¯ç”±ï¼ˆTask Routesï¼‰
4. ä»»åŠ¡åºåˆ—åŒ–
5. æ—¶åŒºé…ç½®
"""

import os
from celery import Celery
from celery.schedules import crontab

# Redis è¿æ¥é…ç½®
# æ”¯æŒä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæ–¹ä¾¿è¿æ¥ Docker Redis æˆ–å…¶ä»– Redis å®ä¾‹
REDIS_HOST = os.getenv('REDIS_HOST', 'localhost')
REDIS_PORT = os.getenv('REDIS_PORT', '6379')
REDIS_DB = os.getenv('REDIS_DB', '0')
REDIS_PASSWORD = os.getenv('REDIS_PASSWORD', '')

# æ„å»º Redis è¿æ¥å­—ç¬¦ä¸²
# æ ¼å¼: redis://[:password@]host[:port][/database]
if REDIS_PASSWORD:
    redis_url = f'redis://:{REDIS_PASSWORD}@{REDIS_HOST}:{REDIS_PORT}/{REDIS_DB}'
else:
    redis_url = f'redis://{REDIS_HOST}:{REDIS_PORT}/{REDIS_DB}'

print(f"ğŸ”— è¿æ¥ Redis: {redis_url.replace(REDIS_PASSWORD, '***') if REDIS_PASSWORD else redis_url}")

# åˆ›å»º Celery åº”ç”¨å®ä¾‹
# broker: æ¶ˆæ¯ä»£ç†ï¼Œç”¨äºå‘é€å’Œæ¥æ”¶ä»»åŠ¡æ¶ˆæ¯
# backend: ç»“æœåç«¯ï¼Œç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœ
app = Celery(
    'celery_learning',
    broker=redis_url,  # Redis ä½œä¸ºæ¶ˆæ¯ä»£ç†
    backend=redis_url,  # Redis ä½œä¸ºç»“æœåç«¯
    include=[
        'tasks.basic_tasks',      # åŸºç¡€ä»»åŠ¡æ¨¡å—
        'tasks.advanced_tasks',   # é«˜çº§ä»»åŠ¡æ¨¡å—
        'tasks.realworld_tasks',  # å®é™…å·¥ç¨‹ä»»åŠ¡æ¨¡å—
    ]
)

# ============================================================================
# Celery é…ç½®è¯¦è§£
# ============================================================================
# app.conf.update() ç”¨äºæ›´æ–° Celery åº”ç”¨çš„é…ç½®
# è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ: CELERY_CONFIG.md
# ============================================================================

app.conf.update(
    # ------------------------------------------------------------------------
    # 1. ä»»åŠ¡åºåˆ—åŒ–é…ç½®
    # ------------------------------------------------------------------------
    # task_serializer: ä»»åŠ¡å‚æ•°åºåˆ—åŒ–æ ¼å¼
    #   - 'json': JSON æ ¼å¼ï¼ˆæ¨èï¼Œå®‰å…¨ï¼Œè·¨è¯­è¨€å…¼å®¹ï¼‰
    #   - 'pickle': Python pickleï¼ˆä¸å®‰å…¨ï¼Œä»… Pythonï¼‰
    #   - 'yaml': YAML æ ¼å¼ï¼ˆäººç±»å¯è¯»ï¼Œæ€§èƒ½è¾ƒä½ï¼‰
    #   - 'msgpack': MessagePackï¼ˆäºŒè¿›åˆ¶ï¼Œé«˜æ•ˆï¼‰
    task_serializer='json',
    
    # accept_content: Worker æ¥å—çš„å†…å®¹ç±»å‹
    #   åªæ¥å— JSON å¯ä»¥é˜²æ­¢ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆpickle ä¸å®‰å…¨ï¼‰
    accept_content=['json'],
    
    # result_serializer: ä»»åŠ¡ç»“æœåºåˆ—åŒ–æ ¼å¼
    #   åº”ä¸ task_serializer ä¿æŒä¸€è‡´
    result_serializer='json',
    
    # ------------------------------------------------------------------------
    # 2. æ—¶åŒºé…ç½®
    # ------------------------------------------------------------------------
    # timezone: Celery ä½¿ç”¨çš„æ—¶åŒº
    #   å½±å“å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å’Œæ—¥å¿—æ—¶é—´æˆ³
    timezone='Asia/Shanghai',
    
    # enable_utc: å¯ç”¨ UTC æ—¶é—´
    #   æ¨è Trueï¼Œå†…éƒ¨ä½¿ç”¨ UTCï¼Œæ˜¾ç¤ºæ—¶è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº
    enable_utc=True,
    
    # ------------------------------------------------------------------------
    # 3. ä»»åŠ¡è·¯ç”±é…ç½®
    # ------------------------------------------------------------------------
    # task_routes: å°†ä¸åŒç±»å‹çš„ä»»åŠ¡è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—
    #   ä½œç”¨ï¼š
    #   1. ä»»åŠ¡éš”ç¦»ï¼šä¸åŒç±»å‹çš„ä»»åŠ¡äº’ä¸å½±å“
    #   2. ä¼˜å…ˆçº§å¤„ç†ï¼šé‡è¦ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œ
    #   3. èµ„æºåˆ†é…ï¼šæ ¹æ®ä»»åŠ¡ç‰¹æ€§åˆ†é…èµ„æº
    #
    #   æ¨¡å¼åŒ¹é…è§„åˆ™ï¼š
    #   - 'tasks.basic_tasks.*': åŒ¹é…è¯¥æ¨¡å—ä¸‹æ‰€æœ‰ä»»åŠ¡ï¼ˆé€šé…ç¬¦ *ï¼‰
    #   - 'tasks.basic_tasks.add': ç²¾ç¡®åŒ¹é…ç‰¹å®šä»»åŠ¡
    #   - ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆ
    #
    #   è·¯ç”±è¿‡ç¨‹ï¼š
    #   ä»»åŠ¡æäº¤ â†’ æ£€æŸ¥ task_routes â†’ åŒ¹é…è·¯ç”±è§„åˆ™ â†’ å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—
    #
    #   Worker å¿…é¡»ç›‘å¬ç›¸åº”çš„é˜Ÿåˆ—ï¼š
    #   celery -A celery_app worker --queues=basic,advanced,realworld
    #
    #   è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ: TASK_ROUTES_DEEP_DIVE.md
    task_routes={
        'tasks.basic_tasks.*': {'queue': 'basic'},        # åŸºç¡€ä»»åŠ¡é˜Ÿåˆ—
        'tasks.advanced_tasks.*': {'queue': 'advanced'},  # é«˜çº§ä»»åŠ¡é˜Ÿåˆ—
        'tasks.realworld_tasks.*': {'queue': 'realworld'}, # å®é™…å·¥ç¨‹ä»»åŠ¡é˜Ÿåˆ—
    },
    
    # ------------------------------------------------------------------------
    # 4. ä»»åŠ¡ä¼˜å…ˆçº§é…ç½®
    # ------------------------------------------------------------------------
    # task_default_priority: ä»»åŠ¡çš„é»˜è®¤ä¼˜å…ˆçº§
    #   èŒƒå›´: 0-9ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    #   ä»»åŠ¡è°ƒç”¨æ—¶å¯ä»¥é€šè¿‡ priority å‚æ•°è¦†ç›–
    task_default_priority=5,
    
    # ------------------------------------------------------------------------
    # 5. ä»»åŠ¡æ‰§è¡Œè¶…æ—¶è®¾ç½®
    # ------------------------------------------------------------------------
    # task_time_limit: ç¡¬è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    #   è¶…è¿‡æ­¤æ—¶é—´ï¼ŒWorker ä¸»è¿›ç¨‹ä¼šå¼ºåˆ¶ç»ˆæ­¢æ‰§è¡Œä»»åŠ¡çš„å­è¿›ç¨‹ï¼ˆSIGKILLï¼‰
    #   ä¸ºä»€ä¹ˆæ˜¯è¿›ç¨‹çº§åˆ«ï¼Ÿ
    #   - Python æ— æ³•çœŸæ­£"ä¸­æ–­"æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼ˆGIL é™åˆ¶ï¼‰
    #   - ä»»åŠ¡å¯èƒ½åœ¨é˜»å¡æ“ä½œä¸­ï¼ˆç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶ I/Oï¼‰æ— æ³•ä¸­æ–­
    #   - ä»»åŠ¡å¯èƒ½é™·å…¥æ­»å¾ªç¯ï¼Œæ— æ³•é€šè¿‡å¼‚å¸¸ä¸­æ–­
    #   å½±å“ï¼š
    #   - âœ… ä»»åŠ¡åœæ­¢æ‰§è¡Œï¼ˆè¾¾åˆ°ç›®çš„ï¼‰
    #   - âŒ æ— æ³•æ‰§è¡Œæ¸…ç†ä»£ç ï¼ˆfinally å—ä¸ä¼šæ‰§è¡Œï¼‰
    #   - âŒ æ— æ³•ä¿å­˜ä¸­é—´çŠ¶æ€
    #   - âŒ å¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼ˆæ–‡ä»¶å¥æŸ„ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰
    #   - âŒ å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
    #   åº”è°¨æ…è®¾ç½®ï¼Œæ¨èä½¿ç”¨è½¯è¶…æ—¶ + ç¡¬è¶…æ—¶ç»„åˆ
    task_time_limit=300,  # 5åˆ†é’Ÿ
    
    # task_soft_time_limit: è½¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    #   è¶…è¿‡æ­¤æ—¶é—´ï¼Œè§¦å‘ SoftTimeLimitExceeded å¼‚å¸¸
    #   ä»»åŠ¡å¯ä»¥æ•è·å¼‚å¸¸å¹¶ä¼˜é›…é€€å‡ºï¼Œæ¸…ç†èµ„æº
    #   æ¨èè®¾ç½®ä¸ºç¡¬è¶…æ—¶çš„ 80%
    #   ç¤ºä¾‹ï¼š
    #   try:
    #       # ä»»åŠ¡é€»è¾‘
    #   except SoftTimeLimitExceeded:
    #       cleanup()  # æ¸…ç†èµ„æº
    #       raise
    task_soft_time_limit=240,  # 4åˆ†é’Ÿ
    
    # ------------------------------------------------------------------------
    # 6. Worker é…ç½®
    # ------------------------------------------------------------------------
    # âš ï¸  é‡è¦: Celery é»˜è®¤ä½¿ç”¨å¤šè¿›ç¨‹ï¼ˆPreforkï¼‰ï¼Œä¸æ˜¯å¤šçº¿ç¨‹ï¼
    #   - æ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹çš„ Worker å­è¿›ç¨‹ä¸­æ‰§è¡Œ
    #   - è¿›ç¨‹éš”ç¦»ï¼Œä¸€ä¸ªä»»åŠ¡å´©æºƒä¸å½±å“å…¶ä»–ä»»åŠ¡
    #   - å¯ä»¥ç»•è¿‡ Python çš„ GILï¼ŒçœŸæ­£åˆ©ç”¨å¤šæ ¸ CPU
    #   - é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡
    #
    #   æ‰§è¡Œæ¨¡å‹é€‰æ‹©:
    #   - Preforkï¼ˆé»˜è®¤ï¼‰: å¤šè¿›ç¨‹ï¼Œé€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡
    #   - Eventlet/Gevent: åç¨‹ï¼Œé€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡
    #   - Solo: å•çº¿ç¨‹ï¼Œä»…ç”¨äºè°ƒè¯•
    #
    #   è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ: CELERY_EXECUTION_MODEL.md
    
    # worker_prefetch_multiplier: æ¯ä¸ª Worker å­è¿›ç¨‹é¢„å–çš„ä»»åŠ¡æ•°
    #   é¢„å–æ•° = worker_prefetch_multiplier Ã— Worker å¹¶å‘æ•°
    #   å€¼å¤§: æé«˜ååé‡ï¼Œä½†å¯èƒ½å¯¼è‡´ä»»åŠ¡åˆ†é…ä¸å‡
    #   å€¼å°: ä»»åŠ¡åˆ†é…æ›´å‡åŒ€ï¼Œä½†å¯èƒ½é™ä½ååé‡
    #   æ¨èå€¼: 2-4
    worker_prefetch_multiplier=4,
    
    # worker_max_tasks_per_child: æ¯ä¸ª Worker å­è¿›ç¨‹æ‰§è¡Œçš„æœ€å¤§ä»»åŠ¡æ•°
    #   è¾¾åˆ°æ­¤æ•°é‡åï¼ŒWorker ä¼šåˆ›å»ºæ–°çš„å­è¿›ç¨‹
    #   ç›®çš„: é˜²æ­¢å†…å­˜æ³„æ¼
    #   æ¨èå€¼: 1000-5000ï¼ˆæ ¹æ®ä»»åŠ¡å†…å­˜ä½¿ç”¨æƒ…å†µè°ƒæ•´ï¼‰
    worker_max_tasks_per_child=1000,
    
    # å…¶ä»– Worker é…ç½®ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
    # worker_concurrency: Worker å¹¶å‘æ•°ï¼ˆé»˜è®¤æ˜¯ CPU æ ¸å¿ƒæ•°ï¼‰
    # worker_pool: Worker æ± ç±»å‹ï¼ˆ'prefork', 'solo', 'eventlet', 'gevent'ï¼‰
    #   - 'prefork': å¤šè¿›ç¨‹ï¼ˆé»˜è®¤ï¼Œé€‚åˆ CPU å¯†é›†å‹ï¼‰
    #   - 'eventlet': åç¨‹ï¼ˆé€‚åˆ I/O å¯†é›†å‹ï¼Œéœ€è¦ pip install eventletï¼‰
    #   - 'gevent': åç¨‹ï¼ˆé€‚åˆ I/O å¯†é›†å‹ï¼Œéœ€è¦ pip install geventï¼‰
    #   - 'solo': å•çº¿ç¨‹ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
    # task_acks_late: ä»»åŠ¡å®Œæˆåæ‰ç¡®è®¤ï¼ˆé»˜è®¤ Falseï¼‰
    # task_reject_on_worker_lost: Worker ä¸¢å¤±æ—¶æ‹’ç»ä»»åŠ¡ï¼ˆé»˜è®¤ Falseï¼‰
    
    # ------------------------------------------------------------------------
    # 7. ç»“æœåç«¯é…ç½®
    # ------------------------------------------------------------------------
    # result_expires: ä»»åŠ¡ç»“æœè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    #   é˜²æ­¢ç»“æœæ•°æ®æ— é™å¢é•¿ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
    #   é»˜è®¤: 1 å¤©ï¼ˆ86400 ç§’ï¼‰
    #   æ¨è: æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®ï¼ˆ1å°æ—¶åˆ°å‡ å¤©ä¸ç­‰ï¼‰
    result_expires=3600,  # 1å°æ—¶åè¿‡æœŸ
    
    # ------------------------------------------------------------------------
    # 8. å®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆBeat Scheduleï¼‰
    # ------------------------------------------------------------------------
    # beat_schedule: å®šä¹‰å®šæ—¶ä»»åŠ¡çš„è°ƒåº¦è®¡åˆ’
    #   éœ€è¦å¯åŠ¨ Celery Beat è¿›ç¨‹æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡
    #   å¯åŠ¨å‘½ä»¤: celery -A celery_app beat --loglevel=info
    beat_schedule={
        # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡ç®€å•ä»»åŠ¡
        'periodic-simple-task': {
            'task': 'tasks.basic_tasks.periodic_task',
            'schedule': 30.0,  # å›ºå®šé—´éš”ï¼ˆç§’ï¼‰
        },
        # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
        'daily-task': {
            'task': 'tasks.basic_tasks.daily_task',
            'schedule': crontab(hour=2, minute=0),  # Crontab è¡¨è¾¾å¼
        },
        # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹æ‰§è¡Œ
        # day_of_week: 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
        'weekly-task': {
            'task': 'tasks.basic_tasks.weekly_task',
            'schedule': crontab(hour=9, minute=0, day_of_week=1),
        },
        # æ›´å¤šè°ƒåº¦æ–¹å¼ç¤ºä¾‹:
        # - crontab(minute='*/5'): æ¯5åˆ†é’Ÿ
        # - crontab(day_of_month=1): æ¯æœˆ1å·
        # - solar('sunrise', lat, lon): åŸºäºæ—¥å‡ºæ—¥è½
    },
)

# å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œå¯ä»¥å¯åŠ¨ worker
if __name__ == '__main__':
    app.start()

