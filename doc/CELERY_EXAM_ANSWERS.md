# ğŸ“ Celery ç»¼åˆèƒ½åŠ›è€ƒè¯• - ç­”æ¡ˆè¯¦è§£

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šé€‰æ‹©é¢˜ç­”æ¡ˆ

### 1. B - å¤šè¿›ç¨‹ï¼ˆPreforkï¼‰

**è§£æ**: Celery é»˜è®¤ä½¿ç”¨ Prefork æ¨¡å¼ï¼Œå³å¤šè¿›ç¨‹æ¨¡å‹ï¼Œä¸æ˜¯å¤šçº¿ç¨‹ã€‚

---

### 2. B - å­è¿›ç¨‹

**è§£æ**: åœ¨ Prefork æ¨¡å¼ä¸‹ï¼Œä»»åŠ¡åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œï¼Œä¸»è¿›ç¨‹åªè´Ÿè´£ç®¡ç†ã€‚

---

### 3. C - Eventlet

**è§£æ**: Eventlet ä½¿ç”¨åç¨‹ï¼Œé€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ã€‚Prefork é€‚åˆ CPU å¯†é›†å‹ï¼ŒSolo ä»…ç”¨äºè°ƒè¯•ã€‚

---

### 4. B - æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹ä»é˜Ÿåˆ—ç«äº‰è·å–ä»»åŠ¡

**è§£æ**: è¿™æ˜¯ Celery çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¸æ˜¯ä¸»è¿›ç¨‹åˆ†é…ï¼Œè€Œæ˜¯æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹ç«äº‰è·å–ã€‚

---

### 5. C - 16

**è§£æ**: é¢„å–æ•° = worker_prefetch_multiplier Ã— concurrency = 4 Ã— 4 = 16

---

### 6. C - `--pool=prefork --concurrency=4`

**è§£æ**: CPU å¯†é›†å‹ä»»åŠ¡åº”è¯¥ä½¿ç”¨ Prefork æ¨¡å¼ï¼Œå¹¶å‘æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚

---

### 7. B - è¯¥æ¨¡å—ä¸‹çš„æ‰€æœ‰ä»»åŠ¡

**è§£æ**: `*` æ˜¯é€šé…ç¬¦ï¼ŒåŒ¹é…è¯¥æ¨¡å—ä¸‹çš„æ‰€æœ‰ä»»åŠ¡ã€‚

---

### 8. B - æ¯ä¸ªå­è¿›ç¨‹æœ‰ç‹¬ç«‹çš„è¿æ¥

**è§£æ**: åœ¨ Prefork æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹éœ€è¦é‡æ–°è¿æ¥ Redisï¼Œä¸èƒ½å…±äº«ä¸»è¿›ç¨‹çš„è¿æ¥ã€‚

---

### 9. D - B å’Œ C

**è§£æ**: COW æœºåˆ¶æ—¢å‡å°‘äº†å†…å­˜å ç”¨ï¼Œåˆæé«˜äº†è¿›ç¨‹åˆ›å»ºé€Ÿåº¦ã€‚

---

### 10. D - A å’Œ C éƒ½å¯ä»¥

**è§£æ**: `--queues` å’Œ `-Q` éƒ½å¯ä»¥æŒ‡å®šé˜Ÿåˆ—ï¼Œä¸¤è€…ç­‰ä»·ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå¡«ç©ºé¢˜ç­”æ¡ˆ

1. **æ¶ˆæ¯ä»£ç†ï¼ˆBrokerï¼‰**ã€**ç»“æœåç«¯ï¼ˆBackendï¼‰**ã€**Worker**

2. **1**ã€**4**

3. **é¢„å–æ•° = worker_prefetch_multiplier Ã— concurrency**

4. **BRPOP**ã€**åŸå­æ“ä½œ**

5. **è¿›ç¨‹ç®¡ç†**ã€**ä¿¡å·å¤„ç†**ã€**æ—¥å¿—èšåˆ**

6. **JSON**ã€**pickle**

7. **åŒä¸€ä¸ªè¿›ç¨‹**ã€**åŒä¸€ä¸ªçº¿ç¨‹**ã€**åç¨‹åˆ‡æ¢**

8. **é˜²æ­¢å†…å­˜æ³„æ¼**

9. **é¡ºåºåŒ¹é…**ã€**ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™**

10. **fork()**ã€**å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰**

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ¤æ–­é¢˜ç­”æ¡ˆ

1. âŒ **é”™è¯¯** - Celery é»˜è®¤ä½¿ç”¨å¤šè¿›ç¨‹ï¼ˆPreforkï¼‰ï¼Œä¸æ˜¯å¤šçº¿ç¨‹

2. âŒ **é”™è¯¯** - ä¸»è¿›ç¨‹åªè´Ÿè´£ç®¡ç†ï¼Œä¸æ‰§è¡Œä»»åŠ¡

3. âŒ **é”™è¯¯** - é¢„å–æ•°è¿‡å¤§ä¼šå¯¼è‡´è´Ÿè½½ä¸å‡è¡¡

4. âœ… **æ­£ç¡®** - æ¯ä¸ªå­è¿›ç¨‹æœ‰ç‹¬ç«‹çš„ Redis è¿æ¥

5. âŒ **é”™è¯¯** - Solo æ¨¡å¼ä»…ç”¨äºè°ƒè¯•ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ

---

## ç¬¬å››éƒ¨åˆ†ï¼šç®€ç­”é¢˜ç­”æ¡ˆè¯¦è§£

### 1. Prefork å’Œ Eventlet çš„åŒºåˆ«

**è¯¦ç»†ç­”æ¡ˆ**:

**Prefork æ¨¡å¼**:
- **æ‰§è¡Œæ–¹å¼**: å¤šè¿›ç¨‹ï¼Œæ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­æ‰§è¡Œ
- **å¹¶å‘æœºåˆ¶**: çœŸæ­£çš„å¹¶è¡Œï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- **è¿›ç¨‹éš”ç¦»**: ä¸€ä¸ªä»»åŠ¡å´©æºƒä¸å½±å“å…¶ä»–ä»»åŠ¡
- **å†…å­˜å ç”¨**: è¾ƒå¤§ï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼‰
- **é€‚ç”¨åœºæ™¯**: CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆè®¡ç®—ã€å›¾åƒå¤„ç†ã€æ•°æ®åˆ†æç­‰ï¼‰
- **é™åˆ¶**: å—è¿›ç¨‹æ•°é™åˆ¶ï¼Œä¸èƒ½è®¾ç½®å¾ˆé«˜çš„å¹¶å‘æ•°

**Eventlet æ¨¡å¼**:
- **æ‰§è¡Œæ–¹å¼**: åç¨‹ï¼Œæ‰€æœ‰ä»»åŠ¡åœ¨åŒä¸€ä¸ªè¿›ç¨‹çš„åç¨‹ä¸­æ‰§è¡Œ
- **å¹¶å‘æœºåˆ¶**: é€šè¿‡åç¨‹åˆ‡æ¢å®ç°å¹¶å‘ï¼ˆéçœŸæ­£å¹¶è¡Œï¼‰
- **è¿›ç¨‹éš”ç¦»**: æ— ï¼ˆæ‰€æœ‰åç¨‹åœ¨åŒä¸€è¿›ç¨‹ï¼‰
- **å†…å­˜å ç”¨**: è¾ƒå°ï¼ˆåç¨‹å…±äº«è¿›ç¨‹å†…å­˜ï¼‰
- **é€‚ç”¨åœºæ™¯**: I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œã€æ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰
- **é™åˆ¶**: å— GIL é™åˆ¶ï¼Œä¸é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡

**é€‰æ‹©å»ºè®®**:
- CPU å¯†é›†å‹ â†’ Prefork
- I/O å¯†é›†å‹ â†’ Eventlet/Gevent
- æ··åˆä»»åŠ¡ â†’ ä½¿ç”¨å¤šä¸ª Workerï¼Œä¸åŒé˜Ÿåˆ—ä½¿ç”¨ä¸åŒ Pool

---

### 2. ä»»åŠ¡åˆ†é…æœºåˆ¶

**è¯¦ç»†ç­”æ¡ˆ**:

**"ä¸æ˜¯åˆ†é…"çš„å«ä¹‰**:
- ä¸»è¿›ç¨‹ä¸ä¼šä»é˜Ÿåˆ—è·å–ä»»åŠ¡
- ä¸»è¿›ç¨‹ä¸ä¼šå°†ä»»åŠ¡åˆ†é…ç»™å­è¿›ç¨‹
- ä¸»è¿›ç¨‹åªè´Ÿè´£è¿›ç¨‹ç®¡ç†ï¼ˆåˆ›å»º/é”€æ¯å­è¿›ç¨‹ï¼‰

**"ç«äº‰è·å–"çš„å«ä¹‰**:
- æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹è¿æ¥ Redis
- æ¯ä¸ªå­è¿›ç¨‹ä½¿ç”¨ `BRPOP` å‘½ä»¤ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
- `BRPOP` æ˜¯åŸå­æ“ä½œï¼ŒRedis ä¿è¯æ¯ä¸ªä»»åŠ¡åªè¢«ä¸€ä¸ªè¿›ç¨‹è·å–
- å¤šä¸ªè¿›ç¨‹åŒæ—¶è°ƒç”¨ `BRPOP`ï¼Œè°å…ˆè·å–åˆ°è°æ‰§è¡Œ

**ä¼˜åŠ¿**:
- é¿å…äº†ä¸»è¿›ç¨‹æˆä¸ºç“¶é¢ˆ
- æé«˜äº†å¹¶å‘æ€§èƒ½
- ç®€åŒ–äº†æ¶æ„ï¼ˆä¸éœ€è¦ä»»åŠ¡åˆ†å‘é€»è¾‘ï¼‰

**ç¤ºä¾‹**:
```
é˜Ÿåˆ—: [ä»»åŠ¡1, ä»»åŠ¡2, ä»»åŠ¡3, ä»»åŠ¡4]

å­è¿›ç¨‹ 1: BRPOP basic â†’ è·å–ä»»åŠ¡1
å­è¿›ç¨‹ 2: BRPOP basic â†’ è·å–ä»»åŠ¡2
å­è¿›ç¨‹ 3: BRPOP basic â†’ è·å–ä»»åŠ¡3
å­è¿›ç¨‹ 4: BRPOP basic â†’ è·å–ä»»åŠ¡4
```

---

### 3. é¢„å–æœºåˆ¶

**è¯¦ç»†ç­”æ¡ˆ**:

**å·¥ä½œåŸç†**:
1. æ¯ä¸ªå­è¿›ç¨‹åœ¨ç©ºé—²æ—¶ï¼Œæå‰ä»é˜Ÿåˆ—è·å–å¤šä¸ªä»»åŠ¡åˆ°æœ¬åœ°ç¼“å†²åŒº
2. é¢„å–æ•° = `worker_prefetch_multiplier Ã— concurrency`
3. æ¯ä¸ªå­è¿›ç¨‹é¢„å–æ•° = `worker_prefetch_multiplier`
4. å­è¿›ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼˜å…ˆä»æœ¬åœ°ç¼“å†²åŒºè·å–
5. ç¼“å†²åŒºç©ºäº†ï¼Œå†æ¬¡ä»é˜Ÿåˆ—é¢„å–

**ä¼˜åŠ¿**:
- å‡å°‘ç½‘ç»œå¾€è¿”ï¼ˆä¸€æ¬¡é¢„å–å¤šä¸ªä»»åŠ¡ï¼‰
- æé«˜ååé‡ï¼ˆå­è¿›ç¨‹å¯ä»¥è¿ç»­æ‰§è¡Œä»»åŠ¡ï¼‰
- é™ä½å»¶è¿Ÿï¼ˆä»»åŠ¡å·²ç»åœ¨æœ¬åœ°ç¼“å†²åŒºï¼‰

**åŠ£åŠ¿**:
- è´Ÿè½½ä¸å‡è¡¡ï¼ˆå¿«çš„è¿›ç¨‹é¢„å–æ›´å¤šä»»åŠ¡ï¼‰
- å†…å­˜å ç”¨ï¼ˆæ¯ä¸ªå­è¿›ç¨‹éœ€è¦å­˜å‚¨é¢„å–çš„ä»»åŠ¡ï¼‰
- ä»»åŠ¡åˆ†å¸ƒä¸å‡ï¼ˆæ…¢çš„è¿›ç¨‹å¯èƒ½ç©ºé—²ï¼‰

**é€‰æ‹©ç­–ç•¥**:

**CPU å¯†é›†å‹ä»»åŠ¡**:
```python
worker_prefetch_multiplier=1  # æˆ– 2
```
- åŸå› : ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚å¤§ï¼Œå°é¢„å–æ•°å¯ä»¥æ›´å¥½åœ°å¹³è¡¡è´Ÿè½½

**I/O å¯†é›†å‹ä»»åŠ¡**:
```python
worker_prefetch_multiplier=10  # æˆ–æ›´å¤§
```
- åŸå› : ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›¸å¯¹ç¨³å®šï¼Œå¤§é¢„å–æ•°å¯ä»¥æé«˜ååé‡

**æ··åˆä»»åŠ¡**:
```python
worker_prefetch_multiplier=4  # ä¸­ç­‰å€¼
```

---

### 4. å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰æœºåˆ¶

**è¯¦ç»†ç­”æ¡ˆ**:

**COW æœºåˆ¶åŸç†**:
1. å­è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œä¸ç«‹å³å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜
2. çˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ä»½ç‰©ç†å†…å­˜é¡µï¼ˆåªè¯»ï¼‰
3. åªæœ‰å½“æŸä¸ªè¿›ç¨‹å†™å…¥å†…å­˜é¡µæ—¶ï¼Œæ‰çœŸæ­£å¤åˆ¶è¯¥é¡µ
4. è¿™æ˜¯ Linux/Unix å†…æ ¸çš„ä¼˜åŒ–æœºåˆ¶

**ä¼˜åŠ¿**:
- **åˆ›å»ºé€Ÿåº¦å¿«**: åªéœ€å¤åˆ¶é¡µè¡¨ï¼Œä¸éœ€è¦å¤åˆ¶æ•´ä¸ªå†…å­˜ç©ºé—´
- **å†…å­˜å ç”¨å°**: åªè¯»æ•°æ®åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­å…±äº«
- **èŠ‚çœèµ„æº**: ä»£ç æ®µå’Œå¸¸é‡åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­å…±äº«

**å…±äº«çš„æ•°æ®**ï¼ˆé€šè¿‡ COWï¼‰:
- **ä»£ç æ®µ**: Python å­—èŠ‚ç ã€åº“ä»£ç ï¼ˆåªè¯»ï¼Œå®Œå…¨å…±äº«ï¼‰
- **å¸¸é‡**: å­—ç¬¦ä¸²å­—é¢é‡ã€æ•°å­—å¸¸é‡ï¼ˆåªè¯»ï¼Œå®Œå…¨å…±äº«ï¼‰
- **å¯¼å…¥çš„æ¨¡å—**: æ¨¡å—ä»£ç ï¼ˆåˆå§‹å…±äº«ï¼Œä¿®æ”¹æ—¶å¤åˆ¶ï¼‰
- **å…¨å±€å˜é‡ï¼ˆåªè¯»ï¼‰**: è¯»å–ä¸è§¦å‘å¤åˆ¶ï¼Œå†™å…¥è§¦å‘ COW

**ç‹¬ç«‹çš„æ•°æ®**:
- **å †å†…å­˜**: ä»»åŠ¡æ‰§è¡Œæ—¶åˆ›å»ºçš„å¯¹è±¡ï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ï¼‰
- **æ ˆå†…å­˜**: å‡½æ•°è°ƒç”¨ã€å±€éƒ¨å˜é‡ï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ï¼‰
- **ç½‘ç»œè¿æ¥**: æ¯ä¸ªè¿›ç¨‹éœ€è¦é‡æ–°è¿æ¥ï¼ˆä¸èƒ½å…±äº«ï¼‰
- **æ•°æ®åº“è¿æ¥**: æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤è‡ªå·±çš„è¿æ¥æ± ï¼ˆä¸èƒ½å…±äº«ï¼‰
- **å…¨å±€å˜é‡ï¼ˆå·²ä¿®æ”¹ï¼‰**: COW è§¦å‘åç‹¬ç«‹å‰¯æœ¬

**ç¤ºä¾‹**:
```python
# ä¸»è¿›ç¨‹
shared_list = [1, 2, 3]  # åˆå§‹å…±äº«ï¼ˆCOWï¼‰

# å­è¿›ç¨‹ 1
print(shared_list)  # [1, 2, 3] - ä¸è§¦å‘å¤åˆ¶ï¼ˆåªè¯»ï¼‰
shared_list.append(4)  # è§¦å‘ COWï¼Œå­è¿›ç¨‹ 1 æœ‰ç‹¬ç«‹å‰¯æœ¬

# å­è¿›ç¨‹ 2
print(shared_list)  # [1, 2, 3] - ä¸è§¦å‘å¤åˆ¶ï¼ˆåªè¯»ï¼‰
shared_list.append(5)  # è§¦å‘ COWï¼Œå­è¿›ç¨‹ 2 æœ‰ç‹¬ç«‹å‰¯æœ¬
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šç¼–ç¨‹é¢˜ç­”æ¡ˆè¯¦è§£

### 1. ä»»åŠ¡å®ç°

**å®Œæ•´ä»£ç **:

```python
from celery_app import app
import time

@app.task(
    name='tasks.data_processing.process_data',
    bind=True,  # ç»‘å®šä»»åŠ¡å®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ self
    max_retries=3,  # æœ€å¤šé‡è¯• 3 æ¬¡
    time_limit=60,  # ç¡¬è¶…æ—¶ 60 ç§’
    soft_time_limit=55  # è½¯è¶…æ—¶ 55 ç§’
)
def process_data(self, data_list):
    """
    å¤„ç†æ•°æ®åˆ—è¡¨ï¼Œè®¡ç®—æ¯ä¸ªå…ƒç´ çš„å¹³æ–¹
    
    Args:
        data_list: æ•°æ®åˆ—è¡¨
        self: ä»»åŠ¡å®ä¾‹ï¼ˆbind=True æ—¶è‡ªåŠ¨ä¼ å…¥ï¼‰
    
    Returns:
        å¤„ç†åçš„æ•°æ®åˆ—è¡¨
    """
    try:
        result = []
        total = len(data_list)
        
        for i, item in enumerate(data_list):
            # è®¡ç®—å¹³æ–¹
            squared = item ** 2
            result.append(squared)
            
            # æ›´æ–°è¿›åº¦
            progress = (i + 1) / total * 100
            self.update_state(
                state='PROGRESS',
                meta={
                    'current': i + 1,
                    'total': total,
                    'progress': progress
                }
            )
            
            # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
            time.sleep(0.1)
        
        return result
    
    except Exception as exc:
        # é‡è¯•ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
        raise self.retry(
            exc=exc,
            countdown=2 ** self.request.retries  # æŒ‡æ•°é€€é¿ï¼š2^0, 2^1, 2^2
        )
```

**å…³é”®ç‚¹**:
- `bind=True`: å…è®¸ä½¿ç”¨ `self` è®¿é—®ä»»åŠ¡å®ä¾‹
- `update_state()`: æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
- `self.retry()`: é‡è¯•æœºåˆ¶ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
- `time_limit` å’Œ `soft_time_limit`: è¶…æ—¶æ§åˆ¶

---

### 2. ä»»åŠ¡è·¯ç”±é…ç½®

**å®Œæ•´é…ç½®**:

```python
# celery_app.py
app.conf.update(
    task_routes={
        'tasks.critical.*': {
            'queue': 'critical',
            'priority': 9,  # é«˜ä¼˜å…ˆçº§
        },
        'tasks.normal.*': {
            'queue': 'normal',
            'priority': 5,  # æ™®é€šä¼˜å…ˆçº§
        },
        'tasks.low.*': {
            'queue': 'low',
            'priority': 1,  # ä½ä¼˜å…ˆçº§
        },
        '*': {  # é»˜è®¤è·¯ç”±
            'queue': 'default',
        },
    },
    task_default_queue='default',
    task_default_priority=5,
)
```

**å¯åŠ¨ Worker**:

```bash
# ç›‘å¬æ‰€æœ‰é˜Ÿåˆ—
celery -A celery_app worker \
    --queues=critical,normal,low,default \
    --concurrency=4

# æˆ–è€…ä¸ºä¸åŒé˜Ÿåˆ—å¯åŠ¨ä¸åŒçš„ Worker
celery -A celery_app worker \
    --queues=critical \
    --concurrency=2

celery -A celery_app worker \
    --queues=normal,low,default \
    --concurrency=4
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šåœºæ™¯åˆ†æé¢˜ç­”æ¡ˆè¯¦è§£

### 1. ç”Ÿäº§ç¯å¢ƒæ€§èƒ½é—®é¢˜

**è¯¦ç»†åˆ†æ**:

**å¯èƒ½åŸå› **:
1. **ä»»åŠ¡ç±»å‹ä¸åŒ¹é…**: I/O å¯†é›†å‹ä»»åŠ¡ä½¿ç”¨äº† Prefork æ¨¡å¼
2. **å¹¶å‘æ•°ä¸è¶³**: `--concurrency=4` å¯èƒ½ä¸å¤Ÿ
3. **é¢„å–æ•°è¿‡å¤§**: å¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡è¡¡
4. **ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚å¤§**: æŸäº›ä»»åŠ¡æ‰§è¡Œæ…¢ï¼Œé˜»å¡äº†å…¶ä»–ä»»åŠ¡

**ä¼˜åŒ–æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1: åˆ‡æ¢åˆ° Eventlet æ¨¡å¼ï¼ˆæ¨èï¼Œå¦‚æœæ˜¯ I/O å¯†é›†å‹ï¼‰**
```bash
pip install eventlet

celery -A celery_app worker \
    --pool=eventlet \
    --concurrency=100 \
    --queues=basic,advanced,realworld \
    --prefetch-multiplier=10
```

**æ–¹æ¡ˆ 2: å¢åŠ å¹¶å‘æ•°ï¼ˆå¦‚æœæ˜¯ CPU å¯†é›†å‹ï¼‰**
```bash
# æ£€æŸ¥ CPU æ ¸å¿ƒæ•°
nproc

# è®¾ç½®å¹¶å‘æ•°ç­‰äº CPU æ ¸å¿ƒæ•°
celery -A celery_app worker \
    --pool=prefork \
    --concurrency=8 \
    --queues=basic,advanced,realworld \
    --prefetch-multiplier=2
```

**æ–¹æ¡ˆ 3: è°ƒæ•´é¢„å–æ•°**
```python
app.conf.update(
    worker_prefetch_multiplier=1,  # å‡å°é¢„å–æ•°ï¼Œæé«˜è´Ÿè½½å‡è¡¡
)
```

**æ–¹æ¡ˆ 4: ä»»åŠ¡åˆ†ç±»å¤„ç†ï¼ˆæœ€ä½³å®è·µï¼‰**
```bash
# CPU å¯†é›†å‹ä»»åŠ¡
celery -A celery_app worker \
    --pool=prefork \
    --concurrency=4 \
    --queues=cpu \
    --prefetch-multiplier=2

# I/O å¯†é›†å‹ä»»åŠ¡
celery -A celery_app worker \
    --pool=eventlet \
    --concurrency=100 \
    --queues=io \
    --prefetch-multiplier=10
```

**ç›‘æ§å’ŒéªŒè¯**:
```bash
# ä½¿ç”¨ Flower ç›‘æ§
celery -A celery_app flower

# æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´
celery -A celery_app inspect stats
```

---

### 2. ä»»åŠ¡åˆ†é…ä¸å‡è¡¡

**è¯¦ç»†åˆ†æ**:

**é—®é¢˜åŸå› **:
1. **é¢„å–æ•°è¿‡å¤§**: `worker_prefetch_multiplier=10` å¯¼è‡´æ¯ä¸ªå­è¿›ç¨‹é¢„å– 10 ä¸ªä»»åŠ¡
2. **ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚**: å­è¿›ç¨‹ 1 å’Œ 2 å¯èƒ½è·å–äº†æ‰§è¡Œæ—¶é—´é•¿çš„ä»»åŠ¡
3. **è´Ÿè½½ä¸å‡è¡¡**: å¿«çš„è¿›ç¨‹é¢„å–äº†æ›´å¤šä»»åŠ¡ï¼Œæ…¢çš„è¿›ç¨‹ç©ºé—²

**è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1: å‡å°é¢„å–æ•°ï¼ˆæœ€ç®€å•æœ‰æ•ˆï¼‰**
```python
app.conf.update(
    worker_prefetch_multiplier=1,  # æˆ– 2
)
```

**æ–¹æ¡ˆ 2: ä½¿ç”¨å…¬å¹³åˆ†å‘**
```python
app.conf.update(
    worker_prefetch_multiplier=1,
    task_acks_late=True,  # ä»»åŠ¡å®Œæˆåæ‰ç¡®è®¤
    task_reject_on_worker_lost=True,  # Worker ä¸¢å¤±æ—¶æ‹’ç»ä»»åŠ¡
)
```

**æ–¹æ¡ˆ 3: ä»»åŠ¡åˆ†ç±»**
```python
# å°†æ‰§è¡Œæ—¶é—´é•¿çš„ä»»åŠ¡å’ŒçŸ­ä»»åŠ¡åˆ†å¼€
task_routes={
    'tasks.long_running.*': {'queue': 'long'},
    'tasks.quick.*': {'queue': 'quick'},
}
```

```bash
# ä¸ºä¸åŒé˜Ÿåˆ—é…ç½®ä¸åŒçš„ Worker
celery -A celery_app worker \
    --queues=long \
    --concurrency=2 \
    --prefetch-multiplier=1

celery -A celery_app worker \
    --queues=quick \
    --concurrency=4 \
    --prefetch-multiplier=4
```

**æ–¹æ¡ˆ 4: ç›‘æ§å’Œè°ƒæ•´**
```bash
# ä½¿ç”¨ Flower ç›‘æ§
celery -A celery_app flower

# æ£€æŸ¥æ¯ä¸ª Worker çš„ä»»åŠ¡æ•°
celery -A celery_app inspect active

# æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é¢„å–æ•°å’Œå¹¶å‘æ•°
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ•…éšœæ’æŸ¥é¢˜ç­”æ¡ˆè¯¦è§£

### Worker æ— æ³•è·å–ä»»åŠ¡

**æ’æŸ¥æ­¥éª¤**:

**æ­¥éª¤ 1: æ£€æŸ¥ Worker ç›‘å¬çš„é˜Ÿåˆ—**
```bash
celery -A celery_app inspect active_queues
```

**æ­¥éª¤ 2: æ£€æŸ¥ Redis é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡**
```bash
redis-cli
> LLEN celery  # æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦
> LRANGE celery 0 -1  # æŸ¥çœ‹é˜Ÿåˆ—å†…å®¹
```

**æ­¥éª¤ 3: æ£€æŸ¥ä»»åŠ¡è·¯ç”±é…ç½®**
```python
# ç¡®ä¿ä»»åŠ¡è·¯ç”±åˆ°çš„é˜Ÿåˆ—ä¸ Worker ç›‘å¬çš„é˜Ÿåˆ—ä¸€è‡´
app.conf.task_routes
```

**æ­¥éª¤ 4: æ£€æŸ¥åºåˆ—åŒ–æ ¼å¼**
```python
# ç¡®ä¿ Client å’Œ Worker ä½¿ç”¨ç›¸åŒçš„åºåˆ—åŒ–æ ¼å¼
app.conf.update(
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',
)
```

**æ­¥éª¤ 5: æ£€æŸ¥ Redis è¿æ¥**
```python
import redis
r = redis.Redis(host='localhost', port=6379, db=0)
r.ping()  # åº”è¯¥è¿”å› True
```

**å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**:

**é—®é¢˜ 1: é˜Ÿåˆ—åç§°ä¸åŒ¹é…**
```bash
# ä»»åŠ¡è·¯ç”±åˆ° 'basic' é˜Ÿåˆ—
task_routes={'tasks.*': {'queue': 'basic'}}

# ä½† Worker ç›‘å¬ 'default' é˜Ÿåˆ—
celery -A celery_app worker --queues=default  # âŒ é”™è¯¯

# åº”è¯¥ç›‘å¬ 'basic' é˜Ÿåˆ—
celery -A celery_app worker --queues=basic  # âœ… æ­£ç¡®
```

**é—®é¢˜ 2: åºåˆ—åŒ–æ ¼å¼ä¸åŒ¹é…**
```python
# Client ä½¿ç”¨ JSON
app.conf.task_serializer='json'

# Worker åªæ¥å— JSON
app.conf.accept_content=['json']
```

**é—®é¢˜ 3: Redis è¿æ¥é—®é¢˜**
```python
# æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
redis-cli ping  # åº”è¯¥è¿”å› PONG

# æ£€æŸ¥è¿æ¥é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
```

**é—®é¢˜ 4: ä»»åŠ¡åç§°ä¸åŒ¹é…**
```python
# ç¡®ä¿ä»»åŠ¡åç§°æ­£ç¡®
@app.task(name='tasks.basic_tasks.add')  # ä»»åŠ¡åç§°
def add(x, y):
    return x + y

# è°ƒç”¨æ—¶ä½¿ç”¨æ­£ç¡®çš„ä»»åŠ¡åç§°
from tasks.basic_tasks import add
result = add.delay(3, 5)
```

---

## é™„åŠ æŒ‘æˆ˜é¢˜ç­”æ¡ˆ

### æŒ‘æˆ˜é¢˜ 1: è‡ªå®šä¹‰ä»»åŠ¡è·¯ç”±

```python
from celery_app import app

def route_task(name, args, kwargs, options, task=None, **kw):
    """è‡ªå®šä¹‰ä»»åŠ¡è·¯ç”±å‡½æ•°"""
    # æ£€æŸ¥ä¼˜å…ˆçº§å‚æ•°
    priority = kwargs.get('priority', 'normal')
    
    if priority == 'high':
        return {'queue': 'critical', 'priority': 9}
    elif priority == 'low':
        return {'queue': 'low', 'priority': 1}
    else:
        return {'queue': 'normal', 'priority': 5}

# é…ç½®è·¯ç”±å‡½æ•°
app.conf.task_routes = (route_task,)
```

### æŒ‘æˆ˜é¢˜ 2: ä»»åŠ¡ç›‘æ§å’Œå‘Šè­¦

```python
from celery.signals import task_prerun, task_postrun
from celery_app import app
import time
import logging

logger = logging.getLogger(__name__)

# å­˜å‚¨ä»»åŠ¡å¼€å§‹æ—¶é—´
task_start_times = {}

@task_prerun.connect
def task_prerun_handler(sender=None, task_id=None, task=None, args=None, kwargs=None, **kwds):
    """ä»»åŠ¡å¼€å§‹å‰è®°å½•æ—¶é—´"""
    task_start_times[task_id] = time.time()

@task_postrun.connect
def task_postrun_handler(sender=None, task_id=None, task=None, args=None, kwargs=None, retval=None, state=None, **kwds):
    """ä»»åŠ¡ç»“æŸåæ£€æŸ¥æ‰§è¡Œæ—¶é—´"""
    if task_id in task_start_times:
        start_time = task_start_times[task_id]
        duration = time.time() - start_time
        
        # å¦‚æœæ‰§è¡Œæ—¶é—´è¶…è¿‡ 60 ç§’ï¼Œå‘é€å‘Šè­¦
        if duration > 60:
            logger.warning(
                f"ä»»åŠ¡ {task_id} æ‰§è¡Œæ—¶é—´è¿‡é•¿: {duration:.2f} ç§’"
            )
            # è¿™é‡Œå¯ä»¥å‘é€é‚®ä»¶ã€çŸ­ä¿¡ç­‰å‘Šè­¦
        
        # æ¸…ç†
        del task_start_times[task_id]
```

### æŒ‘æˆ˜é¢˜ 3: æ€§èƒ½ä¼˜åŒ–åˆ†æ

**åœºæ™¯åˆ†æ**:
- 10000 ä¸ª I/O å¯†é›†å‹ä»»åŠ¡
- æ¯ä¸ªä»»åŠ¡æ‰§è¡Œ 1 ç§’
- å½“å‰: Prefork æ¨¡å¼ï¼Œ`--concurrency=4`ï¼Œæ€»æ—¶é—´ 2500 ç§’
- ç›®æ ‡: ä¼˜åŒ–åˆ° 100 ç§’ä»¥å†…

**ä¼˜åŒ–æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1: åˆ‡æ¢åˆ° Eventlet æ¨¡å¼ï¼ˆæ¨èï¼‰**
```bash
celery -A celery_app worker \
    --pool=eventlet \
    --concurrency=100 \
    --prefetch-multiplier=10
```

**è®¡ç®—**:
- 100 ä¸ªåç¨‹å¹¶å‘
- 10000 ä¸ªä»»åŠ¡ Ã· 100 ä¸ªåç¨‹ = 100 æ‰¹
- æ¯æ‰¹ 1 ç§’ï¼ˆI/O æ“ä½œï¼‰
- æ€»æ—¶é—´ â‰ˆ 100 ç§’ âœ…

**æ–¹æ¡ˆ 2: å¢åŠ  Prefork å¹¶å‘æ•°**
```bash
celery -A celery_app worker \
    --pool=prefork \
    --concurrency=100
```

**è®¡ç®—**:
- 100 ä¸ªè¿›ç¨‹å¹¶å‘
- 10000 ä¸ªä»»åŠ¡ Ã· 100 ä¸ªè¿›ç¨‹ = 100 æ‰¹
- æ¯æ‰¹ 1 ç§’
- æ€»æ—¶é—´ â‰ˆ 100 ç§’ âœ…

**ä½†é—®é¢˜**: 100 ä¸ªè¿›ç¨‹ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œä¸æ¨èã€‚

**æ–¹æ¡ˆ 3: ä½¿ç”¨å¤šä¸ª Workerï¼ˆæ°´å¹³æ‰©å±•ï¼‰**
```bash
# å¯åŠ¨ 4 ä¸ª Workerï¼Œæ¯ä¸ª 25 ä¸ªå¹¶å‘
celery -A celery_app worker \
    --pool=eventlet \
    --concurrency=25 \
    --hostname=worker1@%h

celery -A celery_app worker \
    --pool=eventlet \
    --concurrency=25 \
    --hostname=worker2@%h

# ... å…± 4 ä¸ª Worker
```

**è®¡ç®—**:
- 4 ä¸ª Worker Ã— 25 ä¸ªåç¨‹ = 100 ä¸ªå¹¶å‘
- æ€»æ—¶é—´ â‰ˆ 100 ç§’ âœ…

**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ 1ï¼ˆEventlet æ¨¡å¼ï¼‰ï¼Œå› ä¸ºï¼š
- I/O å¯†é›†å‹ä»»åŠ¡é€‚åˆåç¨‹
- å†…å­˜å ç”¨å°
- é…ç½®ç®€å•

---

**ç¥å­¦ä¹ é¡ºåˆ©ï¼** ğŸš€

