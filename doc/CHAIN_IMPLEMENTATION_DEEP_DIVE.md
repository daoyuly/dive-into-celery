# Celery Chain å®ç°æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•

1. [Chain æ ¸å¿ƒæ¦‚å¿µ](#chain-æ ¸å¿ƒæ¦‚å¿µ)
2. [Chain çš„å®ç°åŸç†](#chain-çš„å®ç°åŸç†)
3. [Chain çš„æ•°æ®ç»“æ„](#chain-çš„æ•°æ®ç»“æ„)
4. [Chain çš„æ‰§è¡Œæµç¨‹](#chain-çš„æ‰§è¡Œæµç¨‹)
5. [ç»“æœä¼ é€’æœºåˆ¶](#ç»“æœä¼ é€’æœºåˆ¶)
6. [æºç çº§å®ç°åˆ†æ](#æºç çº§å®ç°åˆ†æ)
7. [Chain çš„é«˜çº§ç‰¹æ€§](#chain-çš„é«˜çº§ç‰¹æ€§)
8. [æ€§èƒ½ä¸é™åˆ¶](#æ€§èƒ½ä¸é™åˆ¶)

---

## Chain æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Chainï¼Ÿ

`chain` æ˜¯ Celery æä¾›çš„ä¸€ä¸ª**ä»»åŠ¡ç»„åˆåŸè¯­ï¼ˆPrimitiveï¼‰**ï¼Œç”¨äºå°†å¤šä¸ªä»»åŠ¡æŒ‰é¡ºåºä¸²è”æ‰§è¡Œï¼Œå…¶ä¸­**å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›å€¼è‡ªåŠ¨ä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„ç¬¬ä¸€ä¸ªå‚æ•°**ã€‚

### åŸºæœ¬ç”¨æ³•

```python
from celery import chain

# æ–¹å¼1: ä½¿ç”¨ chain() å‡½æ•°
workflow = chain(
    task1.s(arg1, arg2),  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæœ‰åˆå§‹å‚æ•°
    task2.s(),             # ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œæ¥æ”¶ task1 çš„è¿”å›å€¼
    task3.s()              # ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼Œæ¥æ”¶ task2 çš„è¿”å›å€¼
)

result = workflow.apply_async()
final_result = result.get()

# æ–¹å¼2: ä½¿ç”¨ç®¡é“è¿ç®—ç¬¦ |
workflow = task1.s(arg1, arg2) | task2.s() | task3.s()
result = workflow.apply_async()
```

### æ‰§è¡Œæµç¨‹ç¤ºæ„

```
task1(arg1, arg2) 
    â†“ è¿”å› result1
task2(result1) 
    â†“ è¿”å› result2
task3(result2) 
    â†“ è¿”å› final_result
```

---

## Chain çš„å®ç°åŸç†

### 1. Chain çš„æœ¬è´¨

`chain` å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä»»åŠ¡ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ª**ç­¾åï¼ˆSignatureï¼‰å¯¹è±¡**ï¼Œå®ƒå°è£…äº†å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå’Œä¾èµ–å…³ç³»ã€‚

### 2. Chain çš„åˆ›å»ºè¿‡ç¨‹

```python
# å½“è°ƒç”¨ chain() æ—¶ï¼Œå†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

from celery import chain
from celery.canvas import _chain

# chain() å‡½æ•°å®é™…ä¸Šæ˜¯ _chain() çš„åŒ…è£…
workflow = chain(
    fetch_data.s('database'),
    process_item.s(),
    save_result.s()
)

# ç­‰ä»·äºï¼š
workflow = _chain(
    fetch_data.s('database'),
    process_item.s(),
    save_result.s()
)
```

### 3. Chain å¯¹è±¡çš„ç»“æ„

Chain å¯¹è±¡å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª**ä»»åŠ¡åˆ—è¡¨**ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ª Signature å¯¹è±¡ï¼š

```python
# ä¼ªä»£ç å±•ç¤º Chain çš„å†…éƒ¨ç»“æ„
class Chain:
    def __init__(self, *tasks):
        self.tasks = list(tasks)  # å­˜å‚¨ä»»åŠ¡ç­¾ååˆ—è¡¨
        self.app = tasks[0].app if tasks else None
    
    def apply_async(self, **kwargs):
        # æ‰§è¡Œé“¾å¼ä»»åŠ¡
        ...
```

---

## Chain çš„æ•°æ®ç»“æ„

### Signature å¯¹è±¡

æ¯ä¸ªä»»åŠ¡é€šè¿‡ `.s()` æ–¹æ³•åˆ›å»º Signatureï¼ˆç­¾åï¼‰å¯¹è±¡ï¼š

```python
# task.s() åˆ›å»º Signature
signature = task.s(arg1, arg2, kwarg1=value1)

# Signature åŒ…å«çš„ä¿¡æ¯ï¼š
# - task: ä»»åŠ¡å‡½æ•°
# - args: ä½ç½®å‚æ•°
# - kwargs: å…³é”®å­—å‚æ•°
# - options: æ‰§è¡Œé€‰é¡¹ï¼ˆqueue, routing_key, priority ç­‰ï¼‰
```

### Chain çš„åºåˆ—åŒ–ç»“æ„

å½“ Chain è¢«åºåˆ—åŒ–åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

```json
{
    "task": "celery.chain",
    "args": [],
    "kwargs": {
        "tasks": [
            {
                "task": "tasks.advanced_tasks.fetch_data",
                "args": ["database"],
                "kwargs": {},
                "options": {}
            },
            {
                "task": "tasks.advanced_tasks.process_item",
                "args": [],
                "kwargs": {},
                "options": {
                    "link": [...]  // é“¾æ¥åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
                }
            },
            {
                "task": "tasks.advanced_tasks.save_result",
                "args": [],
                "kwargs": {},
                "options": {}
            }
        ]
    }
}
```

---

## Chain çš„æ‰§è¡Œæµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å®¢æˆ·ç«¯è°ƒç”¨ workflow.apply_async()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Chain.apply_async()                                      â”‚
â”‚    - åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡çš„ AsyncResult                            â”‚
â”‚    - ä¸ºåç»­ä»»åŠ¡è®¾ç½® link å›è°ƒ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‘é€ç¬¬ä¸€ä¸ªä»»åŠ¡åˆ°æ¶ˆæ¯é˜Ÿåˆ—                                   â”‚
â”‚    - task_id: uuid1                                         â”‚
â”‚    - args: ['database']                                     â”‚
â”‚    - link: [task2_signature]  â† å…³é”®ï¼šé“¾æ¥åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Worker æ¥æ”¶å¹¶æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡                                â”‚
â”‚    - æ‰§è¡Œ fetch_data('database')                            â”‚
â”‚    - è¿”å› result1                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä»»åŠ¡å®Œæˆåï¼Œæ£€æŸ¥ link å›è°ƒ                                â”‚
â”‚    - å‘ç° link ä¸­æœ‰ task2_signature                          â”‚
â”‚    - è‡ªåŠ¨è°ƒç”¨ task2.apply_async(args=[result1])             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å‘é€ç¬¬äºŒä¸ªä»»åŠ¡åˆ°æ¶ˆæ¯é˜Ÿåˆ—                                   â”‚
â”‚    - task_id: uuid2                                         â”‚
â”‚    - args: [result1]  â† å‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æœ                     â”‚
â”‚    - link: [task3_signature]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Worker æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡                                      â”‚
â”‚    - æ‰§è¡Œ process_item(result1)                             â”‚
â”‚    - è¿”å› result2                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡...                                        â”‚
â”‚    - é‡å¤æ­¥éª¤ 5-7ï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. æœ€åä¸€ä¸ªä»»åŠ¡å®Œæˆ                                           â”‚
â”‚    - è¿”å›æœ€ç»ˆç»“æœ                                            â”‚
â”‚    - å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ result.get() è·å–ç»“æœ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æœºåˆ¶ï¼šLink å›è°ƒ

**Link æ˜¯ Chain å®ç°çš„æ ¸å¿ƒæœºåˆ¶**ã€‚æ¯ä¸ªä»»åŠ¡ï¼ˆé™¤äº†æœ€åä¸€ä¸ªï¼‰éƒ½ä¼šåœ¨ `options` ä¸­è®¾ç½® `link` å‚æ•°ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªä»»åŠ¡çš„ç­¾åã€‚

```python
# ä¼ªä»£ç ï¼šChain å¦‚ä½•è®¾ç½® link

def apply_async(self):
    # ç¬¬ä¸€ä¸ªä»»åŠ¡
    first_task = self.tasks[0]
    
    # ä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡è®¾ç½® linkï¼ŒæŒ‡å‘ç¬¬äºŒä¸ªä»»åŠ¡
    if len(self.tasks) > 1:
        first_task.options['link'] = [self.tasks[1]]
    
    # ç¬¬äºŒä¸ªä»»åŠ¡è®¾ç½® linkï¼ŒæŒ‡å‘ç¬¬ä¸‰ä¸ªä»»åŠ¡
    if len(self.tasks) > 2:
        self.tasks[1].options['link'] = [self.tasks[2]]
    
    # ... ä¾æ­¤ç±»æ¨
    
    # æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
    return first_task.apply_async()
```

---

## ç»“æœä¼ é€’æœºåˆ¶

### 1. ç»“æœå¦‚ä½•ä¼ é€’ï¼Ÿ

Chain é€šè¿‡ **link å›è°ƒæœºåˆ¶** å®ç°ç»“æœä¼ é€’ï¼š

1. **ä»»åŠ¡å®Œæˆæ—¶è§¦å‘ link**ï¼šå½“ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶ï¼ŒCelery ä¼šè‡ªåŠ¨æ£€æŸ¥è¯¥ä»»åŠ¡çš„ `link` é€‰é¡¹
2. **è‡ªåŠ¨è°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡**ï¼šå¦‚æœå­˜åœ¨ linkï¼ŒCelery ä¼šå°†å½“å‰ä»»åŠ¡çš„ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ link ä¸­çš„ä»»åŠ¡
3. **ç»“æœä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°**ï¼šä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ”¶å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›å€¼ä½œä¸ºç¬¬ä¸€ä¸ªä½ç½®å‚æ•°

### 2. ç»“æœä¼ é€’çš„ä»£ç ç¤ºä¾‹

```python
@app.task
def task_a(x):
    return x + 1

@app.task
def task_b(x):
    return x * 2

@app.task
def task_c(x):
    return x - 3

# åˆ›å»º chain
workflow = chain(
    task_a.s(5),    # è¾“å…¥: 5, è¾“å‡º: 6
    task_b.s(),     # è¾“å…¥: 6 (è‡ªåŠ¨ä¼ é€’), è¾“å‡º: 12
    task_c.s()      # è¾“å…¥: 12 (è‡ªåŠ¨ä¼ é€’), è¾“å‡º: 9
)

# æ‰§è¡Œæµç¨‹ï¼š
# task_a(5) â†’ è¿”å› 6
#   â†“ (link å›è°ƒï¼Œè‡ªåŠ¨ä¼ é€’ç»“æœ)
# task_b(6) â†’ è¿”å› 12
#   â†“ (link å›è°ƒï¼Œè‡ªåŠ¨ä¼ é€’ç»“æœ)
# task_c(12) â†’ è¿”å› 9 (æœ€ç»ˆç»“æœ)
```

### 3. å¤šå‚æ•°ä¼ é€’

å¦‚æœå‰ä¸€ä¸ªä»»åŠ¡è¿”å›çš„æ˜¯**å…ƒç»„æˆ–åˆ—è¡¨**ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°ï¼š

```python
@app.task
def task_a():
    return (1, 2, 3)  # è¿”å›å…ƒç»„

@app.task
def task_b(x, y, z):  # æ¥æ”¶ä¸‰ä¸ªå‚æ•°
    return x + y + z

# Chain ä¼šè‡ªåŠ¨è§£åŒ…å…ƒç»„
workflow = chain(task_a.s(), task_b.s())
# task_a() â†’ (1, 2, 3)
# task_b(1, 2, 3) â†’ 6
```

### 4. ç»“æœä¼ é€’çš„å†…éƒ¨å®ç°

```python
# ä¼ªä»£ç ï¼šWorker æ‰§è¡Œä»»åŠ¡åçš„å¤„ç†

def execute_task(task, args, kwargs):
    # 1. æ‰§è¡Œä»»åŠ¡
    result = task.run(*args, **kwargs)
    
    # 2. å­˜å‚¨ç»“æœ
    backend.store_result(task_id, result, state='SUCCESS')
    
    # 3. æ£€æŸ¥ link å›è°ƒ
    if 'link' in task.options:
        for next_task_signature in task.options['link']:
            # 4. å°†å½“å‰ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡
            next_task_signature.apply_async(
                args=[result]  # å…³é”®ï¼šç»“æœä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
            )
    
    return result
```

---

## æºç çº§å®ç°åˆ†æ

### 1. Chain ç±»çš„å®šä¹‰

Celery çš„ Chain å®ç°ä½äº `celery/canvas.py`ï¼š

```python
# celery/canvas.py (ç®€åŒ–ç‰ˆ)

class chain(Signature):
    """Chain ä»»åŠ¡ç­¾å"""
    
    def __init__(self, *tasks, **options):
        # å°†ä»»åŠ¡åˆ—è¡¨è½¬æ¢ä¸º Signature å¯¹è±¡
        tasks = [maybe_signature(task) for task in tasks]
        
        # è®¾ç½®ä»»åŠ¡ä¹‹é—´çš„ link å…³ç³»
        if tasks:
            # ç¬¬ä¸€ä¸ªä»»åŠ¡
            first_task = tasks[0]
            
            # ä¸ºæ¯ä¸ªä»»åŠ¡ï¼ˆé™¤æœ€åä¸€ä¸ªï¼‰è®¾ç½® link
            for i in range(len(tasks) - 1):
                current_task = tasks[i]
                next_task = tasks[i + 1]
                
                # å°†ä¸‹ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°å½“å‰ä»»åŠ¡çš„ link
                if 'link' not in current_task.options:
                    current_task.options['link'] = []
                current_task.options['link'].append(next_task)
            
            # Chain æœ¬èº«çš„è¡Œä¸ºç­‰åŒäºç¬¬ä¸€ä¸ªä»»åŠ¡
            super().__init__(
                first_task.task,
                args=first_task.args,
                kwargs=first_task.kwargs,
                **first_task.options
            )
            
            self.tasks = tasks
        else:
            self.tasks = []
    
    def apply_async(self, **kwargs):
        """å¼‚æ­¥æ‰§è¡Œ Chain"""
        if not self.tasks:
            return None
        
        # æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆåç»­ä»»åŠ¡é€šè¿‡ link è‡ªåŠ¨è§¦å‘ï¼‰
        return self.tasks[0].apply_async(**kwargs)
    
    def __or__(self, other):
        """æ”¯æŒ | è¿ç®—ç¬¦"""
        return chain(*(self.tasks + [other]))
```

### 2. Link å›è°ƒçš„æ‰§è¡Œ

Worker åœ¨æ‰§è¡Œä»»åŠ¡åï¼Œä¼šæ£€æŸ¥ link å¹¶è‡ªåŠ¨è°ƒç”¨ï¼š

```python
# celery/worker/request.py (ç®€åŒ–ç‰ˆ)

class Request:
    def on_success(self, retval, task_id, args, kwargs):
        """ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶çš„å›è°ƒ"""
        # å­˜å‚¨ç»“æœ
        self.task.backend.store_result(
            task_id, retval, state='SUCCESS'
        )
        
        # æ‰§è¡Œ link å›è°ƒ
        if self.request.get('callbacks'):
            for callback in self.request['callbacks']:
                # callback æ˜¯ä¸‹ä¸€ä¸ªä»»åŠ¡çš„ç­¾å
                callback.apply_async(
                    args=[retval],  # å°†å½“å‰ç»“æœä½œä¸ºå‚æ•°
                    kwargs={}
                )
    
    def on_failure(self, exc, task_id, args, kwargs, einfo):
        """ä»»åŠ¡å¤±è´¥æ—¶çš„å›è°ƒ"""
        # å­˜å‚¨å¤±è´¥çŠ¶æ€
        self.task.backend.store_result(
            task_id, None, state='FAILURE', traceback=einfo
        )
        
        # æ‰§è¡Œ error linkï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if self.request.get('errbacks'):
            for errback in self.request['errbacks']:
                errback.apply_async(
                    args=[exc],
                    kwargs={}
                )
```

### 3. æ¶ˆæ¯åºåˆ—åŒ–

Chain åœ¨åºåˆ—åŒ–æ—¶ï¼Œä¼šå°† link ä¿¡æ¯åŒ…å«åœ¨æ¶ˆæ¯ä¸­ï¼š

```python
# celery/app/task.py (ç®€åŒ–ç‰ˆ)

def _build_message(self, task_id, args, kwargs, **options):
    """æ„å»ºä»»åŠ¡æ¶ˆæ¯"""
    message = {
        'id': task_id,
        'task': self.name,
        'args': args,
        'kwargs': kwargs,
        'callbacks': [],  # link å›è°ƒåˆ—è¡¨
        'errbacks': [],   # error link å›è°ƒåˆ—è¡¨
    }
    
    # æ·»åŠ  link å›è°ƒ
    if 'link' in options:
        for link_task in options['link']:
            message['callbacks'].append(
                link_task.as_dict()  # åºåˆ—åŒ–ä¸‹ä¸€ä¸ªä»»åŠ¡çš„ç­¾å
            )
    
    return message
```

---

## Chain çš„é«˜çº§ç‰¹æ€§

### 1. Chain ä¸ Group çš„ç»„åˆ

Chain å¯ä»¥ä¸ Group ç»„åˆä½¿ç”¨ï¼Œå®ç°å¤æ‚çš„å·¥ä½œæµï¼š

```python
from celery import chain, group

# å…ˆæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæœ€åèšåˆç»“æœ
workflow = chain(
    fetch_data.s('source'),
    group(
        process_item.s(),
        process_item.s(),
        process_item.s(),
    ),
    aggregate_results.s()
)

# æ‰§è¡Œæµç¨‹ï¼š
# 1. fetch_data('source') â†’ è¿”å› data
# 2. å¹¶è¡Œæ‰§è¡Œï¼š
#    - process_item(data)
#    - process_item(data)
#    - process_item(data)
# 3. aggregate_results([result1, result2, result3]) â†’ æœ€ç»ˆç»“æœ
```

### 2. é”™è¯¯å¤„ç†ï¼šError Link

Chain æ”¯æŒé”™è¯¯å›è°ƒï¼ˆerror linkï¼‰ï¼Œå½“ä»»åŠ¡å¤±è´¥æ—¶å¯ä»¥æ‰§è¡Œé”™è¯¯å¤„ç†ä»»åŠ¡ï¼š

```python
from celery import chain

@app.task
def error_handler(task_id, error):
    print(f"ä»»åŠ¡ {task_id} å¤±è´¥: {error}")
    # æ‰§è¡Œé”™è¯¯å¤„ç†é€»è¾‘
    return "é”™è¯¯å·²å¤„ç†"

# ä½¿ç”¨ link_error è®¾ç½®é”™è¯¯å›è°ƒ
workflow = (
    task1.s() | 
    task2.s() | 
    task3.s()
)

# ä¸ºæ•´ä¸ª chain è®¾ç½®é”™è¯¯å›è°ƒ
workflow.link_error(error_handler.s())
```

### 3. éƒ¨åˆ†å‚æ•°ä¼ é€’

Chain æ”¯æŒéƒ¨åˆ†å‚æ•°ä¼ é€’ï¼Œå¯ä»¥åŒæ—¶ä¼ é€’å‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æœå’Œå›ºå®šå‚æ•°ï¼š

```python
@app.task
def task_a():
    return 10

@app.task
def task_b(x, multiplier):
    return x * multiplier

# task_b æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š
# - x: æ¥è‡ª task_a çš„ç»“æœ
# - multiplier: å›ºå®šå€¼ 5
workflow = chain(
    task_a.s(),
    task_b.s(multiplier=5)  # éƒ¨åˆ†å‚æ•°
)

# æ‰§è¡Œï¼štask_a() â†’ 10, task_b(10, multiplier=5) â†’ 50
```

### 4. Chain çš„åµŒå¥—

Chain å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼š

```python
inner_chain = chain(task1.s(), task2.s())
outer_chain = chain(
    task0.s(),
    inner_chain,  # åµŒå¥—çš„ chain
    task3.s()
)
```

---

## æ€§èƒ½ä¸é™åˆ¶

### 1. æ€§èƒ½ç‰¹ç‚¹

**ä¼˜ç‚¹ï¼š**
- âœ… **é¡ºåºæ‰§è¡Œä¿è¯**ï¼šä»»åŠ¡ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œé€‚åˆæœ‰ä¾èµ–å…³ç³»çš„ä»»åŠ¡æµ
- âœ… **è‡ªåŠ¨ç»“æœä¼ é€’**ï¼šæ— éœ€æ‰‹åŠ¨è·å–å’Œä¼ é€’ç»“æœï¼Œç®€åŒ–ä»£ç 
- âœ… **å¼‚æ­¥æ‰§è¡Œ**ï¼šæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å®¢æˆ·ç«¯

**ç¼ºç‚¹ï¼š**
- âŒ **ä¸²è¡Œæ‰§è¡Œ**ï¼šä»»åŠ¡å¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œæ— æ³•å¹¶è¡Œ
- âŒ **å»¶è¿Ÿç´¯ç§¯**ï¼šæ€»æ‰§è¡Œæ—¶é—´ = æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„æ€»å’Œ
- âŒ **å•ç‚¹æ•…éšœ**ï¼šé“¾ä¸­ä»»ä½•ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œåç»­ä»»åŠ¡éƒ½ä¸ä¼šæ‰§è¡Œ

### 2. ä½¿ç”¨åœºæ™¯

**é€‚åˆä½¿ç”¨ Chain çš„åœºæ™¯ï¼š**
- æ•°æ®ç®¡é“ï¼šETL æµç¨‹ï¼ˆExtract â†’ Transform â†’ Loadï¼‰
- å·¥ä½œæµï¼šéœ€è¦ä¸¥æ ¼é¡ºåºæ‰§è¡Œçš„ä»»åŠ¡åºåˆ—
- ä¾èµ–å…³ç³»ï¼šåä¸€ä¸ªä»»åŠ¡å¿…é¡»ä¾èµ–å‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æœ

**ä¸é€‚åˆä½¿ç”¨ Chain çš„åœºæ™¯ï¼š**
- ç‹¬ç«‹ä»»åŠ¡ï¼šä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼ˆåº”ä½¿ç”¨ Groupï¼‰
- éœ€è¦å¹¶è¡Œå¤„ç†ï¼šå¤§é‡ç‹¬ç«‹ä»»åŠ¡éœ€è¦å¹¶è¡Œæ‰§è¡Œ
- å®¹é”™è¦æ±‚é«˜ï¼šéœ€è¦éƒ¨åˆ†ä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡

### 3. æœ€ä½³å®è·µ

```python
# âœ… å¥½çš„å®è·µï¼šä»»åŠ¡ä¹‹é—´æœ‰æ˜ç¡®çš„ä¾èµ–å…³ç³»
workflow = chain(
    fetch_data.s('source'),      # è·å–æ•°æ®
    validate_data.s(),           # éªŒè¯æ•°æ®ï¼ˆä¾èµ–æ•°æ®ï¼‰
    transform_data.s(),          # è½¬æ¢æ•°æ®ï¼ˆä¾èµ–éªŒè¯ç»“æœï¼‰
    save_data.s()                # ä¿å­˜æ•°æ®ï¼ˆä¾èµ–è½¬æ¢ç»“æœï¼‰
)

# âŒ ä¸å¥½çš„å®è·µï¼šä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»
workflow = chain(
    task1.s(),  # ç‹¬ç«‹ä»»åŠ¡
    task2.s(),  # ç‹¬ç«‹ä»»åŠ¡
    task3.s()   # ç‹¬ç«‹ä»»åŠ¡
)
# åº”è¯¥ä½¿ç”¨ group() å¹¶è¡Œæ‰§è¡Œ
```

### 4. é”™è¯¯å¤„ç†å»ºè®®

```python
# ä¸ºæ¯ä¸ªä»»åŠ¡è®¾ç½®é‡è¯•æœºåˆ¶
@app.task(bind=True, max_retries=3)
def task_with_retry(self, data):
    try:
        # ä»»åŠ¡é€»è¾‘
        return process(data)
    except Exception as exc:
        raise self.retry(exc=exc, countdown=60)

# ä¸º Chain è®¾ç½®é”™è¯¯å›è°ƒ
workflow = chain(
    task1.s(),
    task2.s(),
    task3.s()
).on_error(error_handler.s())
```

---

## æ€»ç»“

### Chain çš„æ ¸å¿ƒè¦ç‚¹

1. **Link æœºåˆ¶**ï¼šChain é€šè¿‡ link å›è°ƒå®ç°ä»»åŠ¡ä¹‹é—´çš„è‡ªåŠ¨è¿æ¥
2. **ç»“æœä¼ é€’**ï¼šå‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æœè‡ªåŠ¨ä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„ç¬¬ä¸€ä¸ªå‚æ•°
3. **é¡ºåºæ‰§è¡Œ**ï¼šä»»åŠ¡ä¸¥æ ¼æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œ
4. **å¼‚æ­¥æ‰§è¡Œ**ï¼šæ¯ä¸ªä»»åŠ¡éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å®¢æˆ·ç«¯

### Chain çš„å®ç°ç²¾é«“

Chain çš„å®ç°éå¸¸å·§å¦™ï¼š
- å®ƒä¸æ˜¯ä¸€ä¸ªæ–°çš„ä»»åŠ¡ç±»å‹ï¼Œè€Œæ˜¯**å¤šä¸ª Signature çš„ç»„åˆ**
- é€šè¿‡ **link é€‰é¡¹** åœ¨ä»»åŠ¡ä¹‹é—´å»ºç«‹è¿æ¥
- Worker åœ¨æ‰§è¡Œä»»åŠ¡å**è‡ªåŠ¨æ£€æŸ¥å¹¶æ‰§è¡Œ link å›è°ƒ**
- å®ç°äº†**å£°æ˜å¼çš„å·¥ä½œæµå®šä¹‰**ï¼Œä»£ç ç®€æ´ä¼˜é›…

### ä¸å…¶ä»–åŸè¯­çš„å¯¹æ¯”

| ç‰¹æ€§ | Chain | Group | Chord |
|------|-------|-------|-------|
| æ‰§è¡Œæ–¹å¼ | é¡ºåºæ‰§è¡Œ | å¹¶è¡Œæ‰§è¡Œ | å¹¶è¡Œ + å›è°ƒ |
| ç»“æœä¼ é€’ | è‡ªåŠ¨ä¼ é€’ | ç‹¬ç«‹ç»“æœ | èšåˆåä¼ é€’ |
| é€‚ç”¨åœºæ™¯ | æœ‰ä¾èµ–çš„ä»»åŠ¡æµ | ç‹¬ç«‹ä»»åŠ¡ | å¹¶è¡Œåèšåˆ |
| æ‰§è¡Œæ—¶é—´ | ç´¯åŠ  | æœ€é•¿ä»»åŠ¡æ—¶é—´ | æœ€é•¿ä»»åŠ¡æ—¶é—´ + å›è°ƒæ—¶é—´ |

---

## å‚è€ƒèµ„æ–™

- [Celery Canvas æ–‡æ¡£](https://docs.celeryq.dev/en/stable/userguide/canvas.html)
- [Celery Chain æºç ](https://github.com/celery/celery/blob/main/celery/canvas.py)
- [ä»»åŠ¡ç­¾åå’ŒåŸè¯­](https://docs.celeryq.dev/en/stable/userguide/canvas.html#signatures)

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2024å¹´*
*æœ€åæ›´æ–°ï¼š2024å¹´*

